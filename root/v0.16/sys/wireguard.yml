ApiVersion: v0.16

Args:
- Name: namespace
  Kind: String
  Default: wireguard
- Name: puid
  Kind: String
  Default: 1000
- Name: pgid
  Kind: String
  Default: 1000
- Name: dns
  Kind: String
  Default: "1.1.1.1"
- Name: config-path
  Kind: String
  Default: /opt/containers/wireguard

Namespace: ${{ Args.namespace }}

Cargoes:
- Name: wgsrv
  Container:
    Image: lscr.io/linuxserver/wireguard:latest
    Cmd:
    - -c
    - SERVERURL=$NANOCL_NODE_ADDR sh /init
    Env:
    - PUID=${{ Args.puid }}
    - PGID=${{ Args.pgid }}
    # Set this to your desired users, they will be created automatically
    # When the container start
    # You can add multiple users separated by comma
    - PEERS=${{ Env.WG_USERS }}
    - PERSISTENTKEEPALIVE_PEERS=all
    HostConfig:
      PortBindings:
        51820/udp:
        - HostPort: "51820"
      CapAdd:
      - NET_ADMIN
      Dns:
      # nanocl will replace this $$INTERNAL_GATEWAY variable with the internal gateway ip
      # which will allow wireguard to resolve internal services
      # registered by nanocl internal dns
      - $$INTERNAL_GATEWAY
      - ${{ Args.dns }}
      Binds:
      -  ${{ Args.config-path }}/config:/config
      Sysctls:
        net.ipv4.ip_forward: "1"
